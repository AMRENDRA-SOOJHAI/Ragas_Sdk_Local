### SQL DATA/TABLE COMPARISON METRIC
'''
DataCompyScore Metric used for ---> Table-output comparison / data quality similarity metric
'''

from ragas.metrics.collections import DataCompyScore

data1 = """acct_id,dollar_amt,name,float_fld,date_fld
10000001234,123.45,George Maharis,14530.1555,2017-01-01
10000001235,0.45,Michael Bluth,1,2017-01-01
10000001236,1345,George Bluth,,2017-01-01
10000001237,123456,Bob Loblaw,345.12,2017-01-01
10000001238,1.05,Lucille Bluth,,2017-01-01
10000001238,1.05,Loose Seal Bluth,,2017-01-01
"""

data2 = """acct_id,dollar_amt,name,float_fld
10000001234,123.4,George Michael Bluth,14530.155
10000001235,0.45,Michael Bluth,
10000001236,1345,George Bluth,1
10000001237,123456,Robert Loblaw,345.12
10000001238,1.05,Loose Seal Bluth,111
"""
async def test_sql_eval():
    metric = DataCompyScore(mode="columns", metric="f1")
    result = await metric.ascore(response=data1, reference=data2)

    return result

# ----------------------------------------------------------------------------------------------------------------------------------------
### SQL Semantic Equivalence
'''
SQL Semantic Equivalence Metric used for ---> SQL query Generated by the LLM is semantically equivalent to the reference SQL query
'''

from openai import AsyncOpenAI
from ragas.llms.base import llm_factory
from ragas.metrics.collections import SQLSemanticEquivalence

# Initialize the LLM
client = AsyncOpenAI()
llm = llm_factory("gpt-4o-mini", client=client)

# Create the metric
metric = SQLSemanticEquivalence(llm=llm)

# Evaluate SQL equivalence
async def run_sql_equivalence():
    result = await metric.ascore(
        response="""
            SELECT p.product_name, SUM(oi.quantity) AS total_quantity
            FROM order_items oi
            JOIN products p ON oi.product_id = p.product_id
            GROUP BY p.product_name;
        """,
        reference="""
            SELECT products.product_name, SUM(order_items.quantity) AS total_quantity
            FROM order_items
            INNER JOIN products ON order_items.product_id = products.product_id
            GROUP BY products.product_name;
        """,
        reference_contexts=[
            """
            Table order_items:
            - order_item_id: INT
            - order_id: INT
            - product_id: INT
            - quantity: INT
            """,
            """
            Table products:
            - product_id: INT
            - product_name: VARCHAR
            - price: DECIMAL
            """
        ]
    )

    print(f"Equivalent: {result.value}")
    print(f"Explanation: {result.reason}")
    return result
